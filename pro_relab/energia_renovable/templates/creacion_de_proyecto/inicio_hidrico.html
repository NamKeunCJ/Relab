{% block head %} {% include 'layouts/head.html' %} {% endblock %}
<script>
    $(function() {
        $('#tabla').DataTable({
            "language": {
                "emptyTable": "No hay datos disponibles en la tabla",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                "infoFiltered": "(filtrado de _MAX_ entradas totales)",
                "lengthMenu": "Mostrar _MENU_ entradas",
                "loadingRecords": "Cargando...",
                "processing": "Procesando...",
                "search": "Buscar:",
                "zeroRecords": "No se encontraron registros coincidentes",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            }
        });
    });
</script>
<div class="col-sm-4">
    <h5 class="title-subpro"> • {{ pro_h[1] }}</h5>
</div>
<div class="card shadow-lg card-flush h-md-50 mb-5 mb-xl-10" style="padding: 1rem; height: 80vh; position: relative;">
    <div id="scrollContainer" class="card-body" style="overflow-x: auto; overflow-y: auto; position: relative; height: 100%;">
        
        {% if pro_com[3] is not none %}
            <table class="motobomba icon_table" draggable="true">
                <tr><td>
                    <div class="col d-flex align-items-end justify-content-center ">                        
                        <a class="nav-link tooltip_btn project_motobomba" href="/hidrica/modal_motobomba_project?id_pro={{ pro_com[0] }}" data-bs-toggle="tooltip" data-bs-placement="top"
                        data-bs-custom-class="custom-tooltip"
                        data-bs-title="{{ pro_com[10] }}">
                            <img src="{{ url_for('static', filename='images/motobomba.png') }}" class="imagen-iluminada" style="width: 12rem;">
                        </a>
                    </div>
                </td></tr>
            </table>
        {% endif %}        
        {% if pro_com[45] != 0 %}
            <table class="tanque icon_table" draggable="true">
                <tr><td>
                    <div class="col d-flex align-items-end justify-content-center"> 
                        {% set ranges = [
                            (0, 10, 'tanque0.png'),
                            (10, 25, 'tanque1.png'),
                            (25, 50, 'tanque2.png'),
                            (50, 75, 'tanque3.png'),
                            (75, 100, 'tanque4.png'),
                            (100, 9999999999, 'tanque5.png')
                        ] %}
                        
                        {% for range in ranges %}
                            {% if pro_com[45] >= range[0] and pro_com[45] < range[1] %}
                                <a class="nav-link tooltip_btn project_tanque" href="/hidrica/modal_tanque_project?id_pro={{ pro_com[0] }}" data-bs-toggle="tooltip" data-bs-placement="top"
                                data-bs-custom-class="custom-tooltip"
                                data-bs-title="{{ pro_com[45] }} L/m³">
                                    <img src="{{ url_for('static', filename='images/' + range[2]) }}" class="imagen-iluminada" style="width: 10rem;">
                                </a>
                            {% endif %}
                        {% endfor %}
                    </div>
                </td></tr>
            </table>
        {% endif %}

        {% if pro_com[25] is not none and pro_com[30] is not none %}
            <table class="generador icon_table" draggable="true">
                <tr><td>
                    <div class="d-flex flex-column align-items-center">
                        <!-- Contenedor para las dos imágenes en la misma fila -->
                        <div class="d-flex justify-content-center align-items-center">
                            <!-- Primera imagen (Caudalímetro) -->
                            <a class="nav-link tooltip_btn project_caudalimetro" style="margin-top: 8rem;"
                               href="/hidrica/modal_caudalimetro_project?id_pro={{ pro_com[0] }}" 
                               data-bs-toggle="tooltip" data-bs-placement="top"
                               data-bs-custom-class="custom-tooltip"
                               data-bs-title="Ingresa Valor Caudalimetro">
                                <img src="{{ url_for('static', filename='images/caudalimetro.png') }}" 
                                     class="imagen-iluminada" 
                                     style="width: 2.5rem; margin-top: 0;">
                            </a>
                            
                            <!-- Segunda imagen (Generador) -->
                            <a class="nav-link tooltip_btn project_generador" 
                               href="/hidrica/modal_generador_project?id_pro={{ pro_com[0] }}" 
                               data-bs-toggle="tooltip" data-bs-placement="top"
                               data-bs-custom-class="custom-tooltip"
                               data-bs-title="{{ pro_com[33] }}">
                                <img src="{{ url_for('static', filename='images/generador.png') }}" 
                                     class="imagen-iluminada" 
                                     style="width: 7rem;">
                            </a>
                        </div>
                        {% set turbina_data = {
                            "Pelton": "turbina1.png",
                            "Michell-Banki": "turbina2.png"
                        } %}
                        
                        {% if pro_com[61] in turbina_data %}
                        <!-- Contenedor para la última imagen (Turbina debajo en la base) -->
                        <div class="d-flex justify-content-center align-items-center" style="margin-top: -3.1rem;">
                            <a class="nav-link tooltip_btn project_turbina_alabes" 
                               href="/hidrica/modal_turbina_alabes_project?id_pro={{ pro_com[0] }}" 
                               data-bs-toggle="tooltip" data-bs-placement="top"
                               data-bs-custom-class="custom-tooltip"
                               data-bs-title="Turbina {{ pro_com[61] }}">
                                <img src="{{ url_for('static', filename='images/' + turbina_data[pro_com[61]]) }}" 
                                     class="imagen-iluminada" 
                                     style="width: 9.7rem; margin-top: 0;">
                            </a>
                        </div>
                        {% endif %} 
                                               
                    </div>                    
                </td></tr>
            </table>
        {% endif %}
        {% if car_com[0][7]!=0 %}
            {% for car_com in car_com %}
                <table class="carga_{{ car_com[0] }} icon_table" draggable="true" style="text-align: center;">
                    <tr>
                        {% if car_com[1] == "Lineal" and car_com[8]==0.0 %} 
                            {% set carga_img='bombillo-none.png' %}
                        {% elif car_com[1] == "Lineal" and car_com[8]!=0.0 and pro_com[4]==False %} 
                            {% set carga_img = 'bombillo-off.png' %} 
                        {% elif car_com[1] == "Lineal" and car_com[8]!=0.0 and pro_com[4]==True %} 
                            {% set carga_img = 'bombillo.png' %} 
                        {% elif car_com[1] == "Inductiva" and car_com[8]==0.0 %} 
                            {% set carga_img='motor-none.png' %} 
                        {% elif car_com[1] == "Inductiva" and car_com[8]!=0.0 and pro_com[4]==False %} 
                            {% set carga_img= 'motor-off.png' %} 
                        {% elif car_com[1] == "Inductiva" and car_com[8]!=0.0 and pro_com[4]==True %} 
                            {% set carga_img= 'motor.png' %} 
                        {% elif car_com[1] == "No Lineal" and car_com[8]==0.0%}  
                            {% set carga_img='pc-none.png' %} 
                        {% elif car_com[1] == "No Lineal" and car_com[8]!=0.0 and pro_com[4]==False %} 
                            {% set carga_img = 'pc-off.png' %} 
                        {% elif car_com[1] == "No Lineal" and car_com[8]!=0.0 and pro_com[4]==True %} 
                            {% set carga_img = 'pc.png' %} 
                        {% endif %}
                        <td>
                            <div class="col d-flex align-items-end justify-content-center ">  
                                <a class="nav-link tooltip_btn" id="projectCargah_{{ car_com[0] }}" href="/hidrica/modal_carga_pot_hidrica?id_pcar={{car_com[0]}}" data-bs-toggle="tooltip" data-bs-placement="top"
                                data-bs-custom-class="custom-tooltip"
                                data-bs-title="{{ car_com[1]  }}">
                                    <img src="{{ url_for('static', filename='images/' + carga_img) }}" class="imagen-iluminada" style="width: 4rem;">
                                </a>
                            </div>
                        </td>                        
                    </tr>
                </table>
            {% endfor %}
        {% endif %}
        <div class="linea_h"></div>
        {% for car_com in car_com %}
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    function initIcono(x_arr, y_arr,ban_id, x_tan, y_tan, id_pro, x_mot, y_mot, x_reg, y_reg,pcar_id, x_pcar, y_pcar, x_red, y_red, condition) {
                        const generador = document.querySelector(`.generador`);
                        const motobomba = document.querySelector('.motobomba');
                        const regulador = document.querySelector('.regulador');
                        const tanque = document.querySelector(`.tanque`);
                        const carga = document.querySelector(`.carga_${pcar_id}`);
                        const red = document.querySelector('.red');
                        const scrollContainer = document.getElementById('scrollContainer');
            
                        let linea_h1, linea_h2, linea_h3, linea_h4, linea_h5;
            
                        // Revisar si regulador está presente para establecer las conexiones
                        if (condition === 'No') {
                            linea_h1 = generador && regulador ? document.createElement('div') : null;
                            linea_h2 = regulador && tanque ? document.createElement('div') : null;
                            linea_h3 = tanque && motobomba ? document.createElement('div') : null;
                            linea_h4 = motobomba && carga ? document.createElement('div') : null;  // Conexión de motobomba a carga
                            linea_h5 = motobomba && red ? document.createElement('div') : null;  // Conexión de motobomba a red
                        } else {
                            linea_h1 = generador && motobomba ? document.createElement('div') : null;
                            linea_h2 = motobomba && tanque ? document.createElement('div') : null;
                            linea_h3 = null; // Evitar crear una línea entre tanque e motobomba si no hay regulador
                            linea_h4 = motobomba && carga ? document.createElement('div') : null;
                            linea_h5 = motobomba && red ? document.createElement('div') : null;
                        }
            
                        // Añadir las líneas al contenedor
                        linea_h1 && scrollContainer.appendChild(linea_h1).classList.add('linea_h');
                        linea_h2 && scrollContainer.appendChild(linea_h2).classList.add('linea_h');
                        linea_h3 && scrollContainer.appendChild(linea_h3).classList.add('linea_h');
                        linea_h4 && scrollContainer.appendChild(linea_h4).classList.add('linea_h');
                        linea_h5 && scrollContainer.appendChild(linea_h5).classList.add('linea_h');
            
                        const setPos = (el, x, y) => el && Object.assign(el.style, { position: 'absolute', left: `${x}px`, top: `${y}px` });
                        setPos(generador, x_arr, y_arr);
                        setPos(motobomba, x_mot, y_mot);
                        setPos(tanque, x_tan, y_tan);
                        setPos(carga, x_pcar, y_pcar);
                        setPos(red, x_red, y_red); 
            
                        if (condition === 'No') {
                            setPos(regulador, x_reg, y_reg);
                        }
            
                        const calcularCentro = el => {
                            const { left, top, width, height } = el.getBoundingClientRect();
                            const { left: pLeft, top: pTop } = scrollContainer.getBoundingClientRect();
                            return { x: left + width / 2 - pLeft + scrollContainer.scrollLeft, y: top + height / 2 - pTop + scrollContainer.scrollTop };
                        };
            
                        const actualizarLinea_h = (linea_h, el1, el2) => {
                            if (!linea_h || !el1 || !el2) return;
                            const [p1, p2] = [calcularCentro(el1), calcularCentro(el2)];
                            Object.assign(linea_h.style, {
                                width: `${Math.hypot(p2.x - p1.x, p2.y - p1.y)}px`,
                                transform: `rotate(${Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI}deg)`,
                                top: `${p1.y}px`, left: `${p1.x}px`, position: 'absolute'
                            });
                        };
            
                        const actualizarLinea_hs = () => {
                            if (condition === 'No') {
                                // Conexión en caso de que haya regulador
                                actualizarLinea_h(linea_h1, generador, regulador);  // generador a Regulador
                                actualizarLinea_h(linea_h2, regulador, tanque);    // Regulador a tanque
                                actualizarLinea_h(linea_h3, tanque, motobomba);     // tanque a motobomba
                            } else {
                                // Conexión directa sin regulador
                                actualizarLinea_h(linea_h1, generador, motobomba);   // generador a motobomba (si no hay regulador)
                                actualizarLinea_h(linea_h2, motobomba, tanque);     // motobomba a tanque (si aplica)
                            }
                            
                            actualizarLinea_h(linea_h4, motobomba, carga);        // motobomba a Carga
                            actualizarLinea_h(linea_h5, motobomba, red);          // motobomba a Red (si aplica)
                        };

            
                        document.addEventListener('dragstart', e => draggedElement = e.target);
                        document.addEventListener('dragover', e => e.preventDefault());
            
                        document.addEventListener('drop', e => {
                            e.preventDefault();
                            if (!draggedElement) return;
                            const { left: pLeft, top: pTop } = scrollContainer.getBoundingClientRect();
                            const x = Math.max(0, e.clientX - pLeft - draggedElement.offsetWidth / 2 + scrollContainer.scrollLeft);
                            const y = Math.max(0, e.clientY - pTop - draggedElement.offsetHeight / 2 + scrollContainer.scrollTop);
            
                            if (draggedElement === generador) [x_arr, y_arr] = [x, y];
                            else if (draggedElement === motobomba) [x_mot, y_mot] = [x, y];
                            else if (draggedElement === regulador) [x_reg, y_reg] = [x, y];
                            else if (draggedElement === tanque) [x_tan, y_tan] = [x, y];
                            else if (draggedElement === carga) [x_pcar, y_pcar] = [x, y];
                            else if (draggedElement === red) [x_red, y_red] = [x, y]; 
            
                            Object.assign(draggedElement.style, { left: `${x}px`, top: `${y}px` });
            
                            actualizarLinea_hs();
            
                            fetch('/update-coordinates', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    x: x_arr, y: y_arr, pro_id: id_pro,  ban_id,
                                    x_mot, y_mot,
                                    x_reg: condition === 'No' ? x_reg : null,
                                    y_reg: condition === 'No' ? y_reg : null,
                                    x_tan, y_tan, pcar_id, x_pcar, y_pcar, x_red, y_red 
                                })
                            }).then(res => res.json()).then(data => console.log(data.success ? 'Coordenadas actualizadas' : 'Error al actualizar')).catch(console.error);
                        });
            
                        scrollContainer.addEventListener('scroll', actualizarLinea_hs);
                        actualizarLinea_hs();
                    }
            
                    const condition = "{{ pro_com[32] }}";
                    const xIco3 = condition === 'No' ? "{{ x_reg }}" : null;
                    const yIco3 = condition === 'No' ? "{{ y_reg }}" : null;
            
                    initIcono(                    
                        "500",
                        "50",
                        "0",
                        "515",
                        "300",
                        "0",
                        "200",
                        "80",
                        "0",
                        "0",
                        "{{ car_com[0] }}",
                        "{{ car_com[9] }}",
                        "{{ car_com[10] }}",
                        "0",
                        "0",
                        condition
                    );
                });
            </script>
        {% endfor %}
    </div>
</div>





