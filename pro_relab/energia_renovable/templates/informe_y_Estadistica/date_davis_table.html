<script>
    var lastData = null;
    var table;
    var chart;

    // Arrays para los datos del gr치fico
    var radiancionData = [];
    var radiacionAltaData = [];
    var temperaturaData = [];

    $(function() {
        // Inicializa DataTable y guarda la referencia
        table = $('#tablaG').DataTable({
            "language": {
                "emptyTable": "No hay datos disponibles en la tabla",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                "infoFiltered": "(filtrado de _MAX_ entradas totales)",
                "lengthMenu": "Mostrar _MENU_ entradas",
                "loadingRecords": "Cargando...",
                "processing": "Procesando...",
                "search": "Buscar:",
                "zeroRecords": "No se encontraron registros coincidentes",
                "paginate": {
                    "first": "Primero",
                    "last": "칔ltimo",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            },
            "order": [
                [0, "desc"]
            ]
        });
    });

    function updateTable() {
        $.ajax({
            url: '/get_latest_irradiance_data',
            type: 'GET',
            success: function(data) {
                if (data && !areObjectsEqual(data, lastData)) {
                    if (lastData === null) {
                        lastData = data; // Actualiza lastData
                    } else {
                        data.forEach(function(item) {
                            // Agregar fila a la tabla
                            var newRow = [item.created_at, item.prom_irr, item.max_irr, item.temp_out];
                            table.row.add(newRow).draw(false);

                            // 游댳 Agregar tambi칠n al dataset de la gr치fica
                            var time = new Date(item.created_at).getTime();

                            radiancionData.push({ x: time, y: parseFloat(item.prom_irr) });
                            radiacionAltaData.push({ x: time, y: parseFloat(item.max_irr) });
                            temperaturaData.push({ x: time, y: parseFloat(item.temp_out) });
                        });

                        // 游댳 Ordenar por tiempo
                        radiancionData.sort((a, b) => a.x - b.x);
                        radiacionAltaData.sort((a, b) => a.x - b.x);
                        temperaturaData.sort((a, b) => a.x - b.x);

                        // 游댳 Actualizar gr치fica una sola vez
                        chart.updateSeries([
                            { name: 'Radiacion', data: radiancionData },
                            { name: 'Radiacion Alta', data: radiacionAltaData },
                            { name: 'Temperatura (춿C)', data: temperaturaData }
                        ]);

                        lastData = data; // actualizar referencia
                    }
                }
            }
        });
    }

    function areObjectsEqual(obj1, obj2) {
        // Compara los objetos para verificar si son iguales
        return JSON.stringify(obj1) === JSON.stringify(obj2);
    }

    // Llama a la funci칩n updateTable peri칩dicamente
    setInterval(updateTable, 10000); // Configura el intervalo para que coincida con la frecuencia de actualizaci칩n de tus datos
</script>
<!-- Aqu칤 comienza el contenedor encapsulado -->
<div class="irradiancia-card-container">

    <div class="card custom-card shadow-lg mb-4">
        <div class="card-body" style="overflow-x: auto;">
            <h3>游늵 Datos de Irradiancia - Davis</h3>
            {% if db_irr is not none %}
            <table id="tablaG" class="table table-hover table-striped table-borderless">
                <thead>
                    <tr>
                        <th style="min-width: 12rem;">Fecha y Hora</th>
                        <th>Radiaci칩n (W/m)</th>
                        <th>Radiaci칩n Alta (W/m)</th>
                        <th>Temperatura C춿</th>
                    </tr>
                </thead>
                <tbody>
                    {% for db_irr in db_irr %}
                    <tr>
                        <td class="time_irradiance">{{ db_irr[2] }}</td>
                        <td class="avg_irradiance">{{ db_irr[0] }}</td>
                        <td class="highest_irradiance">{{ db_irr[1] }}</td>
                        <td class="temp_out">{{ db_irr[3] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-danger">丘멆잺 Error: No se encontraron datos de irradiancia.</p>
            {% endif %}
        </div>
    </div>

    <div class="card custom-card shadow-lg mb-4">
        <div class="card-body">
            <h3>游늳 Gr치fico de Irradiancia</h3>
            <div id="myChart"></div>
            <button id="exportCSVG" class="btn btn-export btn-secondary mt-3">拘勇 Exportar a CSV</button>
        </div>
    </div>

</div>
<script>
    // Obtener los datos de la tabla y convertirlos en arrays de objetos
    var dates = [];
    radiancionData = [];
    radiacionAltaData = [];
    temperaturaData = [];

    
    document.querySelectorAll('#tablaG tbody tr').forEach(function(row, index) {
        var timeElement = row.querySelector('.time_irradiance');
        var radiancionElement = row.querySelector('.avg_irradiance');
        var radiacionAltaElement = row.querySelector('.highest_irradiance');
        var tempOutElement = row.querySelector('.temp_out');
        
        if (timeElement && radiancionElement && radiacionAltaElement ) {
            var timeText = timeElement.innerText;
            var time = new Date(timeText).getTime();

            var radiancion = parseFloat(radiancionElement.innerText.replace(/,/g, ''));
            var radiacionAlta = parseFloat(radiacionAltaElement.innerText.replace(/,/g, ''));
            var tempOut = parseFloat(tempOutElement.innerText.replace(/,/g, ''));
            
            if (!isNaN(time) && !isNaN(radiancion) && !isNaN(radiacionAlta) ) {
                dates.push(time);
                radiancionData.push({ x: time, y: radiancion });
                radiacionAltaData.push({ x: time, y: radiacionAlta });
                temperaturaData.push({ x: time, y: tempOut });
            } 
        } 
    });

    console.log(radiancionData); // Verificar los datos extra칤dos
    console.log(radiacionAltaData); // Verificar los datos extra칤dos
    window.crear_grafica_davis = function() {
        // Configuraci칩n del gr치fico
        var options = {
            series: [
                {
                    name: 'Radiacion',
                    data: radiancionData
                },
                {
                    name: 'Radiacion Alta',
                    data: radiacionAltaData
                },
                {
                    name: 'Temperatura (춿C)',
                    data: temperaturaData
                }
            ],
            chart: {
                type: 'line',
                height: 300,
                zoom: {
                    type: 'x',
                    enabled: true,
                    autoScaleYaxis: true
                },
                toolbar: {
                    autoSelected: 'zoom',
                    export: {
                        csv: {
                            filename: 'datos_irradiancia',
                            columnDelimiter: ',',
                            headerCategory: 'Fecha y Hora',
                            headerValue: 'Valor',
                            categoryFormatter(x) {
                                // Formatear la fecha y hora para la exportaci칩n CSV
                                return new Date(x).toLocaleDateString() + ' ' + new Date(x).toLocaleTimeString();
                            },
                            valueFormatter(y) {
                                return y.toFixed(2); // Ajusta el formato del valor si es necesario
                            }
                        },
                        svg: {
                            filename: undefined,
                        },
                        png: {
                            filename: undefined,
                        }
                    },
                }
            },
            dataLabels: {
                enabled: false
            },
            markers: {
                size: 0,
            },
            title: {
                text: 'Datos Irradiancia',
                align: 'left'
            },
            fill: {
                type: 'solid',
                gradient: {
                    shadeIntensity: 1,
                    inverseColors: false,
                    opacityFrom: 0.5,
                    opacityTo: 0,
                    stops: [0, 90, 100]
                },
            },
            stroke: {
                width: 1 // Define el grosor de la l칤nea
            },
            yaxis: {
                labels: {
                    formatter: function (val) {
                        return val.toFixed(0); // Muestra los valores en el eje Y
                    },
                },
                title: {
                    text: 'G'
                },
            },
            xaxis: {
                type: 'datetime',
                labels: {
                    formatter: function (value) {
                        var date = new Date(value);
                        return date.toLocaleDateString(); 
                    }
                }
            },
            tooltip: {
                shared: false,
                y: {
                    formatter: function (val, opts) {
                        const seriesName = opts.w.globals.seriesNames[opts.seriesIndex];
                        if (seriesName.includes("Temperatura")) {
                            return val.toFixed(1) + ' 춿C';
                        } else {
                            return val.toFixed(0) + ' W/m';
                        }
                    }
                },
                x: {
                    formatter: function (val) {
                        return new Date(val).toLocaleString();
                    }
                }
            }

        };

        // Crear y renderizar el gr치fico
        chart = new ApexCharts(document.querySelector("#myChart"), options);
        chart.render();
    }
    crear_grafica_davis();
    document.getElementById("exportCSVG").addEventListener("click", function () {
        // Variable para almacenar el contenido del CSV
        let csvContent = "data:text/csv;charset=utf-8,";

        // Encabezados del CSV
        csvContent += "Fecha y Hora,Radiacion,Radiacion Alta,Temperatura (춿C)\n";

        // Exportar los datos de las series de la gr치fica (radiancionData y radiacionAltaData)
        radiancionData.forEach(function (item, index) {
            // Usamos los mismos valores de la serie del gr치fico
            const time = new Date(item.x).toLocaleDateString() + ' ' + new Date(item.x).toLocaleTimeString(); // Formatear la fecha
            const radiacion = item.y.toFixed(2);  // Ajuste de los valores num칠ricos
            const radiacionAlta = radiacionAltaData[index] ? radiacionAltaData[index].y.toFixed(2) : '';  // Aseguramos que haya datos para 'Radiaci칩n Alta'
            const temperatura = temperaturaData[index] ? temperaturaData[index].y.toFixed(2) : '';

            // A침adir la fila al CSV
            csvContent += `${time},${radiacion},${radiacionAlta},${temperatura}\n`;
        });

        // Crear un enlace para descargar el CSV
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "datos_irradiancia_completos.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });


</script> 